# 韌體解包分析筆記

## 1. binwalk 的作用與使用方式

**binwalk** 是一個用於**分析和提取韌體映像及嵌入式檔案系統**的工具 [1-4]。它透過掃描二進制檔案中的**檔案簽名**，可以識別檔案中嵌入的不同組件，例如檔案頭、壓縮檔案、檔案系統、核心和啟動載入器等 [2, 3]. binwalk 被廣泛應用於逆向工程、網路安全和鑑識領域 [2].

**使用方式：**

binwalk 的基本用法是在終端機中執行 `binwalk` 命令，後面接著要分析的韌體檔案路徑 [5].

例如，要對一個名為 `firmware.bin` 的韌體檔案進行簽名掃描，可以使用以下指令：

```bash
binwalk firmware.bin

binwalk 會輸出在韌體檔案中找到的各種簽名及其在檔案中的偏移量和描述
.
要提取韌體中識別到的檔案和檔案系統，可以使用 -e 參數
：

binwalk -e firmware.bin

這個指令會在目前目錄下建立一個名為 _firmware.bin.extracted 的資料夾，並將提取到的內容放置於其中
.
binwalk 支援多種韌體檔案格式，常見的包括 .img, .chk, .bin 等
. 實際上，IDA 可以辨識非常多的檔案格式和處理器. binwalk 底層使用了 libmagic 庫，因此相容 Unix file 工具的 magic 簽名
.
2. 展示你使用的指令
假設我們有一個名為 firmware.chk 的韌體檔案，我們想要使用 binwalk 進行解包。以下是我們可能使用的指令：

binwalk firmware.chk

這個指令會掃描 firmware.chk 並列出其中識別到的組件。如果我們想要解包這些組件，我們會使用：

binwalk -e firmware.chk

執行這個指令後，binwalk 會在目前目錄下建立一個名為 _firmware.chk.extracted 的資料夾，其中包含解包後的檔案和目錄。
3. 說明解包後常見的目錄結構與內容
解包韌體後，常見的目錄結構會反映原始韌體內部的檔案系統。以下是一些常見的目錄及其內容：
•
/bin： 這個目錄通常包含基本的系統命令和可執行檔案，例如 sh (shell), ls, cp 等
. 這些是系統運作所必需的基本工具程式。
•
/lib： 這個目錄存放著系統和應用程式使用的函式庫檔案
. 這些函式庫包含可被多個程式共用的程式碼，例如 C 語言的標準函式庫 libc.so，以及其他特定功能的函式庫。
•
/etc： 這個目錄包含系統的設定檔
. 重要的設定檔如網路配置、系統服務配置、使用者帳號資訊等通常都存放在這裡。修改這些檔案會影響系統的行為。
•
/sbin： 這個目錄類似於 /bin，但通常包含系統管理員使用的特權命令，例如掛載檔案系統 (mount)、設定網路介面 (ifconfig) 等
.
•
/usr： 這個目錄通常包含使用者應用程式和相關檔案，其下可能會有 bin (使用者命令), lib (使用者函式庫), share (共享資料) 等子目錄
.
•
/var： 這個目錄用於存放變動的資料，例如日誌檔案、暫存檔案、Spooler 目錄等
.
•
/tmp： 這個目錄用於存放臨時檔案，其內容在系統重新啟動時可能會被清除
.
•
檔案系統根目錄 (/) 下的其他檔案： 可能包含啟動腳本 (init), 核心映像檔 (vmlinuz), 裝置節點 (dev 目錄) 等。
注意： 實際的目錄結構和內容會因韌體的來源、類型和所運行的嵌入式系統而有所不同
. 例如，一個基於 Linux 的路由器韌體和一個簡單的感測器韌體，其檔案系統結構可能會非常不同。
4. 韌體分析流程圖

flowchart TD
    A[Input File (.img/.chk/.bin)] --> B(binwalk);
    B --> C{Extracted FS (_firmware.extracted)};
    C --> D[手動分析 (檢視檔案結構與內容)];
    C --> E[YARA 掃描 (惡意程式碼特徵)];

這個流程圖描述了韌體分析的基本流程：首先將韌體檔案作為輸入，然後使用 binwalk 進行分析和解包，得到解包後的檔案系統。接著可以進行手動分析，檢視檔案和目錄結構，或者使用 YARA 掃描來尋找已知的惡意程式碼特徵
.
額外補充
固件來源與類型
韌體的來源非常廣泛，包括：
•
網路設備： 路由器、交換器、防火牆等。
•
消費性電子產品： 智能家電、攝影機、電視機等。
•
嵌入式系統： 工業控制系統、醫療設備、汽車電子等
.
韌體的類型也很多樣，例如：
•
完整的設備韌體映像： 包含整個系統的檔案和可執行程式。
•
韌體更新檔案： 只包含需要更新的組件。
•
Bootloader： 負責啟動作業系統的程式碼
.
•
核心映像檔： 作業系統的核心部分
.
•
檔案系統映像檔： 包含檔案和目錄結構的映像
.
理解韌體的來源和類型有助於我們預期解包後會看到哪些內容，以及分析的重點應該放在哪些方面
.
strings 或 hexdump 如何幫助你分析已解包的 firmware
在分析已解包的韌體時，strings 和 hexdump 是非常有用的工具：
•
strings： strings 命令可以從二進制檔案中提取可讀的字串
. 這對於快速了解韌體中可能包含的資訊非常有用，例如：
◦
版本資訊和建構日期： 可以幫助判斷韌體的年代和可能存在的已知漏洞
.
◦
檔案路徑和名稱： 揭示程式可能的組織結構和功能
.
◦
URL 和 IP 位址： 可能指示韌體嘗試連線的網路資源
.
◦
錯誤訊息和除錯資訊： 提供程式運作時的線索
.
◦
硬體相關字串： 例如晶片型號、介面名稱等
.
◦
加密相關字串： 例如演算法名稱，可能暗示使用了加密功能
.
•
例如，使用 strings -n 7 firmware.bin | less 可以提取長度至少為 7 個字元的字串並分頁顯示
. 結合 grep 可以搜尋特定的關鍵字，例如 strings -n 7 firmware.bin | grep "http://" 可以尋找包含 "http://" 的字串. 使用 -t x 參數可以顯示字串在檔案中的十六進制位址
.
•
hexdump： hexdump 命令以十六進制或其他格式顯示檔案的原始二進制資料
. 這對於深入理解檔案的結構和內容非常重要，特別是當 strings 無法提供足夠資訊時：
◦
檔案頭和元數據： 檢查檔案的magic number 和檔案格式標識
.
◦
二進制結構和資料格式： 分析資料的儲存方式和排布。
◦
尋找特定的二進制模式 (byte patterns)： 這對於識別特定的程式碼片段或惡意程式碼特徵非常有用，尤其是在撰寫 YARA 規則時
.
◦
比較不同的檔案或檔案片段： 找出差異之處，例如在分析韌體更新時。
•
例如，使用 hexdump -C firmware.bin | less 可以以規範的十六進制和 ASCII 格式顯示檔案內容並分頁顯示。雖然 hexdump 在來源中沒有詳細說明其分析用途，但其作為查看二進制資料的基礎工具，對於理解檔案內容是至關重要的。
透過結合使用 binwalk, strings 和 hexdump，安全研究人員可以有效地分析韌體，識別潛在的漏洞、惡意程式碼或不安全的配置。
